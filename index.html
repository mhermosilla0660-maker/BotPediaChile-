<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BotPedia Chile ‚Äî Chat educativo</title>
<style>
  :root {--bg:#0b1220;--card:#121a2b;--txt:#e6eefc;--muted:#9fb3d9;--pri:#2d6cdf;}
  html,body {margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  header {padding:14px 16px;border-bottom:1px solid #18223a;background:linear-gradient(180deg,#0e1730,#0b1220)}
  header h1 {margin:0;font-size:18px}
  header p {margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.3}
  .wrap {max-width:900px;margin:0 auto;padding:14px}
  .bar {display:grid;gap:10px;grid-template-columns:1fr; margin:8px 0 12px}
  .row {display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .input, textarea {background:var(--card);border:1px solid #1e2a46;color:var(--txt);border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
  .input:focus, textarea:focus {border-color:#3657a7}
  .btn {background:var(--pri);border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toggle {display:flex;align-items:center;gap:8px}
  .chat {background:var(--card);border:1px solid #1e2a46;border-radius:12px;padding:10px;max-height:60vh;overflow:auto}
  .msg {padding:10px 12px;border-radius:10px;margin:6px 0;line-height:1.35}
  .user {background:#1a2846;align-self:flex-end}
  .bot {background:#0f1a30}
  .meta {color:var(--muted);font-size:12px;margin-bottom:4px}
  textarea {width:100%;min-height:80px;resize:vertical}
  .hint {color:var(--muted);font-size:12px}
  @media (min-width:700px){
    .bar {grid-template-columns: 2fr 1fr}
  }
</style>
</head>
<body>
<header class="wrap">
  <h1>ü§ñ BotPedia Chile ‚Äî Chat educativo</h1>
  <p>Prebriefing y pr√°ctica guiada en pediatr√≠a intrahospitalaria (no urgencias ni UPC). Responde en espa√±ol chileno, con enfoque educativo.</p>
</header>

<main class="wrap">
  <section class="bar">
    <div class="card">
      <div class="row">
        <input id="apiKey" class="input" type="password" placeholder="Pega tu OpenAI API key (se guarda en este dispositivo)" inputmode="text" autocomplete="off" />
        <button id="saveKey" class="btn">Guardar clave</button>
        <button id="clearKey" class="btn" style="background:#6b7280">Borrar</button>
      </div>
      <div class="row">
        <label class="toggle"><input id="tts" type="checkbox" /> Leer respuestas en voz alta</label>
        <select id="model" class="input">
          <option value="gpt-4o-mini">gpt-4o-mini (recomendado)</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="o4-mini">o4-mini</option>
        </select>
        <span class="hint">La clave queda s√≥lo en este navegador.</span>
      </div>
    </div>
  </section>

  <section class="chat" id="chat"></section>

  <section style="margin-top:10px">
    <textarea id="msg" placeholder="Escribe el caso o tu pregunta‚Ä¶ (Enter para enviar, Shift+Enter salto de l√≠nea)"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="send" class="btn">Enviar</button>
      <button id="reset" class="btn" style="background:#ef4444">Reiniciar conversaci√≥n</button>
      <span class="hint" id="status"></span>
    </div>
  </section>
</main>

<script>
/* ====== Estado ====== */
const el = (id)=>document.getElementById(id);
const chat = el("chat");
const msg = el("msg");
const sendBtn = el("send");
const resetBtn = el("reset");
const apiKeyInput = el("apiKey");
const saveKeyBtn = el("saveKey");
const clearKeyBtn = el("clearKey");
const statusEl = el("status");
const ttsToggle = el("tts");
const modelSel = el("model");

let messages = [];
let voices = [];
let voiceReady = false;

/* ====== Prompt de BotPedia Chile (sistema) ====== */
const BOTPEDIA_SYSTEM = `
Eres **BotPedia Chile**, un tutor conversacional para estudiantes de Enfermer√≠a en sala de hospitalizaci√≥n pedi√°trica (no urgencias ni UPC).
Objetivo: guiar prebriefing, valoraci√≥n ABCDE, se√±ales de alarma, checklist de seguridad, y preguntas tipo MCQ (A‚ÄìD) con feedback.
Alcance: educativo; no entregues indicaciones cl√≠nicas reales ni prescripciones. Alinea con lineamientos MINSAL/GES de Chile.
Estilo: espa√±ol chileno, claro, emp√°tico y breve. Fomenta el razonamiento: primero pregunta, luego explica. Cuando el estudiante responda MCQ, valida y fundamenta. 
Si el estudiante trae un caso, estructura en: motivo de consulta, antecedentes relevantes, signos vitales, ABCDE, hip√≥tesis y pr√≥ximos pasos educativos.
`;

/* ====== Utilidades UI ====== */
function addMsg(role, text) {
  const box = document.createElement("div");
  box.className = "msg " + (role === "user" ? "user" : "bot");
  box.innerHTML = `<div class="meta">${role === "user" ? "Estudiante" : "BotPedia"}</div>${escapeHTML(text)}`;
  chat.appendChild(box);
  chat.scrollTop = chat.scrollHeight;
}
function setStatus(t){ statusEl.textContent = t || ""; }
function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

/* ====== TTS (iOS compatible) ====== */
function loadVoices() {
  voices = window.speechSynthesis.getVoices() || [];
  voiceReady = voices.length > 0;
}
loadVoices();
window.speechSynthesis.onvoiceschanged = loadVoices;

function speak(text){
  if(!ttsToggle.checked || !text) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    // escoger voz espa√±ola si existe
    const v = voices.find(v=>/es-|Spanish|Espa√±ol/i.test(v.lang+v.name)) || null;
    if(v) u.voice = v;
    u.lang = (v && v.lang) ? v.lang : "es-CL";
    u.rate = 1;
    window.speechSynthesis.cancel(); // corta cualquier lectura previa
    window.speechSynthesis.speak(u);
  }catch(e){ console.warn("TTS error", e); }
}

/* ====== Persistencia de API key (local, en el dispositivo) ====== */
apiKeyInput.value = localStorage.getItem("OPENAI_KEY") || "";
saveKeyBtn.onclick = ()=>{ localStorage.setItem("OPENAI_KEY", apiKeyInput.value.trim()); setStatus("Clave guardada en este dispositivo."); };
clearKeyBtn.onclick = ()=>{ localStorage.removeItem("OPENAI_KEY"); apiKeyInput.value=""; setStatus("Clave borrada de este dispositivo."); };

/* ====== Inicializa conversaci√≥n ====== */
resetConversation();
function resetConversation(){
  messages = [{ role:"system", content: BOTPEDIA_SYSTEM }];
  chat.innerHTML = "";
  addMsg("bot", "¬°Hola! Soy **BotPedia Chile** üëã. ¬øQu√© caso pedi√°trico quieres practicar hoy? (p. ej., *ni√±o 6 a√±os con tos y fiebre desde anoche*).");
  setStatus("");
}

/* ====== Env√≠o ====== */
msg.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
});
sendBtn.onclick = send;
resetBtn.onclick = resetConversation;

async function send(){
  const apiKey = apiKeyInput.value.trim() || localStorage.getItem("OPENAI_KEY") || "";
  if(!apiKey){ setStatus("Falta tu OpenAI API key."); apiKeyInput.focus(); return; }
  const content = msg.value.trim();
  if(!content) return;

  addMsg("user", content);
  messages.push({ role:"user", content });

  msg.value = "";
  sendBtn.disabled = true;
  setStatus("Pensando‚Ä¶");

  try{
    const model = modelSel.value;
    // Llamada simple (sin streaming) para m√°xima compatibilidad en iPhone
    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization": "Bearer " + apiKey,
        "Content-Type":"application/json"
      },
      body: JSON.stringify({
        model,
        temperature: 0.4,
        messages
      })
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error("API "+res.status+": "+t);
    }

    const data = await res.json();
    const text = (data.choices?.[0]?.message?.content || "").trim();
    if(text){
      addMsg("bot", text.replace(/\*\*/g,"")); // render simple
      messages.push({ role:"assistant", content: text });
      speak(text);
    } else {
      addMsg("bot", "No recib√≠ contenido. ¬øPuedes reformular?");
    }
  }catch(err){
    console.error(err);
    addMsg("bot", "‚ö†Ô∏è Error: "+(err.message||err));
  }finally{
    sendBtn.disabled = false;
    setStatus("");
  }
}

/* ====== Consejo para iPhone (TTS requiere gesto) ====== */
document.addEventListener("touchstart", ()=>{}, {passive:true});
</script>
</body>
</html>
